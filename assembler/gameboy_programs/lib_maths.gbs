# **************************************************************************** #
#                                                           LE - /             #
#                                                               /              #
#    lib_maths.gbs                                    .::    .:/ .      .::    #
#                                                  +:+:+   +:    +:  +:+:+     #
#    By: fcordon <marvin@le-101.fr>                 +:+   +:    +:    +:+      #
#                                                  #+#   #+    #+    #+#       #
#    Created: 2019/09/15 16:51:47 by fcordon      #+#   ##    ##    #+#        #
#    Updated: 2019/09/16 22:30:25 by fcordon     ###    #+. /#+    ###.fr      #
#                                                          /                   #
#                                                         /                    #
# **************************************************************************** #

## SQRT

_sqrt_16:	##sqrt(HL = number)	# return = {HL = result}
#{
#	max = 127 * 127 + 111 * 111 = 0x6F22 (28450) = 168 * 168
	push	DE
	push	BC

	ld		D,	H
	ld		E,	L
	ld		C,	0x15
	ld		HL,	__SQRT16_table_hi + 15

	__SQRT16_loop:
	ld		A,	[HL++]
	inc		C
	sub		A,	D
	jrc		__SQRT16_loop
	jrz		__SQRT16_loop

	dec		HL
	dec		HL
	dec		C
	ld		A,	[HL]
	sub		A,	D
	jrz		__SQRT16_get_this_lo

#	ld		D,	[HL]

	ld		HL,	__SQRT8_table_lo
	ld		B,	0
	add		HL,	BC
	__SQRT16_loop2:
	ld		A,	[HL--]
	dec		C
	sub		A,	E
	jrnc	__SQRT16_loop2

	__SQRT16_get_this_lo:
	ld		L,	C
	ld		H,	0

#	inc		HL
#	inc		HL
#	ld		L,	[HL]
#	jr		__SQRT16_return

#	__SQRT16_get_this_lo:
#	ld		HL,	__SQRT8_table_lo
#	ld		B,	0
#	add		HL,	BC
#	ld		L,	[HL]

	__SQRT16_return:
#		ld	H,	D
		pop	BC
		pop	DE
		ret


	__SQRT16_table_hi:
		.byte	0		0		0		0		0		0		0		0\
				0		0		0		0		0		0		0		0\
				1		1		1		1		1		1		1		2\
				2		2		2		2		3		3		3		3\
				4		4		4		4		5		5		5		5\
				6		6		6		7		7		7		8		8\
				9		9		9		10		10		10		11		11\
				12		12		13		13		14		14		15		15\
				16		16		17		17		18		18		19		19\
				20		20		21		21		22		23		23		24\
				25		25		26		26		27		28		28		29\
				30		30		31		32		33		33		34		35\
				36		36		37		38		39		39		40		41\
				42		43		43		44		45		46		47		48\
				49		49		50		51		52		53		54		55\
				56		57		58		59		60		61		62		63\
				64		65		66		67		68		69		70		71\
				72		73		74		75		76		77		78		79\
				81		82		83		84		85		86		87		89\
				90		91		92		93		95		96		97		98\
				100		101		102		103		105		106		107		108\
				110		111

#}

_sqrt_8:	##sqrt(A = number)	# return = {A = result}
#{
	push	BC
	push	DE
	push	HL
	ld		D,	0
	ld		E,	15
	ld		B,	A

	__SQRT8_loop:
		ld		HL,	__SQRT8_table_lo
		add		HL,	DE
		ld		A,	[HL]
		sub		A,	B
		jrnc	__SQRT8_ret_E
		dec		E
		jr		__SQRT8_loop
	
	__SQRT8_ret_E:
		ld	A,	E
		pop	HL
		pop	DE
		pop	BC
		ret

	__SQRT8_table_lo:
		.byte	0		1		4		9		16		25		36		49\
				64		81		100		121		144		169		196		225\
				0		0x21	0x44	0x69	0x90	0xB9	0xE4	0x11\
				0x40	0x71	0xA4	0xD9	0x10	0x49	0x84	0xC1\
				0x00	0x41	0x84	0xC9	0x10	0x59	0xA4	0xF1\
				0x40	0x91	0xE4	0x39	0x90	0xE9	0x44	0xA1\
				0x00	0x61	0xC4	0x29	0x90	0xF9	0x64	0xD1\
				0x40	0xB1	0x24	0x99	0x10	0x89	0x04	0x81\
				0x00	0x81	0x04	0x89	0x10	0x99	0x24	0xB1\
				0x40	0xD1	0x64	0xF9	0x90	0x29	0xC4	0x61\
				0x00	0xA1	0x44	0xE9	0x90	0x39	0xE4	0x91\
				0x40	0xF1	0xA4	0x59	0x10	0xC9	0x84	0x41\
				0x00	0xC1	0x84	0x49	0x10	0xD9	0xA4	0x71\
				0x40	0x11	0xE4	0xB9	0x90	0x69	0x44	0x21\
				0x00	0xE1	0xC4	0xA9	0x90	0x79	0x64	0x51\
				0x40	0x31	0x24	0x19	0x10	0x09	0x04	0x01\
				0x00	0x01	0x04	0x09	0x10	0x19	0x24	0x31\
				0x40	0x51	0x64	0x79	0x90	0xA9	0xC4	0xE1\
				0x00	0x21	0x44	0x69	0x90	0xB9	0xE4	0x11\
				0x40	0x71	0xA4	0xD9	0x10	0x49	0x84	0xC1\
				0x00	0x41	0x84	0xC9	0x10	0x59	0xA4	0xF1\
				0x40	0x91


#}


## DIV

_div_8:	## div(A = number, C = diviser)	## return {A = result, B = remainder}
#{
	push	DE
	push	BC

	ld	E,	0
	ld	B,	A
	sub	A,	C
	jrc	__return_result

	__loop:
		inc		E
		ld		B,	A
		sub		A,	C
		jrnc	__loop

	__return_result:
	ld	A,	E

	ld	E,	B
	pop	BC
	ld	B,	E
	pop	DE
	ret
#}




_div_16:	##	div(HL = number, DE = diviser)	# ret{result = HL, remainder = DE}
#{
	push	BC

	push	HL
	push	DE
	push	DE
	pop		HL		## HL = diviser + ...
	pop		DE		## DE = number
	pop		BC		## BC = diviser

	ld		BC,	0	## BC = result

	#### opti: HL = (diviser << 1) until (HL > number)

	__DIV16_loop:
		ld		A,	E
		sub		A,	L
		ld		A,	D
		__no_carry:
		sbc		A,	H
		jrc		__ret_C		## underflow
		
		inc		BC
		jr		__DIV16_loop



	__ret_C:
		## get remainder
		ld	A,	C
		add	A,	B
		jrz	__return_BC		## BC == 0
		## HL -= BC (diviser * x - diviser)
		ld	A,	L
		sub	A,	C
		ld	E,	A
		ld	A,	H
		sbc	A,	C
		ld	D,	A

		__return_BC:
		ld	H,	B
		ld	L,	C
		pop	BC
		ret
#}

## MUL

%define	int8_mul_2(n)\
	sla	n
%define	int8_mul_4(n)\
	sla	n\
	sla	n
%define	int8_mul_8(n)\
	sla	n\
	sla	n\
	sla	n
%define	int8_mul_16(n)\
	sla	n\
	sla	n\
	sla	n\
	sla	n
%define	int8_mul_32(n)\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n
%define	int8_mul_64(n)\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n
%define	int8_mul_128(n)\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n\
	sla	n

						
_mul_8:	##mul(n = A, mul = C)	## return {A = result}
#{
	push	BC
	push	DE

	ld	B,	0
	ld	D,	A

	bit	7,	C
	jrz	__MUL_bit6
	int8_mul_128(A)
	add	A,	B
	ld	B,	A
	ld	A,	D

	__MUL_bit6:
		bit	6,	C
		jrz	__MUL_bit5
		int8_mul_64(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_bit5:
		bit	5,	C
		jrz	__MUL_bit4
		int8_mul_32(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_bit4:
		bit	4,	C
		jrz	__MUL_bit3
		int8_mul_16(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_bit3:
		bit	3,	C
		jrz	__MUL_bit2
		int8_mul_8(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_bit2:
		bit	2,	C
		jrz	__MUL_bit1
		int8_mul_4(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_bit1:
		bit	1,	C
		jrz	__MUL_add_A
		int8_mul_2(A)
		add	A,	B
		ld	B,	A
		ld	A,	D

	__MUL_add_A:
	bit	0,	C
	jrz	__end
	add	A,	B
	ld	B,	A

	__end:
	ld	A,	B
	pop	DE
	pop	BC
	ret
#}

%define	SHIFT_15(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_14(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_13(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_12(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_11(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_10(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_9(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_8(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_7(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_6(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_5(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_4(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_3(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_2(hi, lo)\
	sla	lo\
	rl	hi\
	sla	lo\
	rl	hi
%define	SHIFT_1(hi, lo)\
	sla	lo\
	rl	hi

%define ADD_DE_BC	\
	ld		A,	C\
	add		A,	E\
	ld		E,	A\
	ld		A,	B\
	adc		A,	D\
	ld		D,	A\
	ld		B,	H\
	ld		C,	L



%define	tmp_hi	0xFFA0
%define	tmp_lo	0xFFA1

_mul_16:	##	mul_16(HL = number, DE = multiplier)	# result = {HL}
#{
	push	BC
	push	DE

	ld		A,			D
	ld		[tmp_hi],	A
	ld		A,			E
	ld		[tmp_lo],	A

	ld		B,	H
	ld		C,	L
	ld		DE,	0
	ld		A,	[tmp_hi]

	bit		7,	A			## bit 15
	jrz		__MUL16_bit_14
	SHIFT_15(B, C)
	ADD_DE_BC
	ld		A,	[tmp_hi]

	__MUL16_bit_14:
		bit		6,	A			## bit 14
		jrz		__MUL16_bit_13
		SHIFT_14(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_13:
		bit		5,	A			## bit 13
		jrz		__MUL16_bit_12
		SHIFT_13(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_12:
		bit		4,	A			## bit 12
		jrz		__MUL16_bit_11
		SHIFT_12(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_11:
		bit		3,	A			## bit 11
		jrz		__MUL16_bit_10
		SHIFT_11(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_10:
		bit		2,	A			## bit 10
		jrz		__MUL16_bit_9
		SHIFT_10(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_9:
		bit		1,	A			## bit 9
		jrz		__MUL16_bit_8
		SHIFT_9(B, C)
		ADD_DE_BC
		ld		A,	[tmp_hi]

	__MUL16_bit_8:
		bit		0,	A			## bit 8
		jrz		__MUL16_bit_7
		SHIFT_8(B, C)
		ADD_DE_BC

	__MUL16_bit_7:
		ld		A,	[tmp_lo]
		bit		7,	A			## bit 7
		jrz		__MUL16_bit_6
		SHIFT_7(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_6:
		bit		6,	A			## bit 6
		jrz		__MUL16_bit_5
		SHIFT_6(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_5:
		bit		5,	A			## bit 5
		jrz		__MUL16_bit_4
		SHIFT_5(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_4:
		bit		4,	A			## bit 4
		jrz		__MUL16_bit_3
		SHIFT_4(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_3:
		bit		3,	A			## bit 3
		jrz		__MUL16_bit_2
		SHIFT_3(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_2:
		bit		2,	A			## bit 2
		jrz		__MUL16_bit_1
		SHIFT_2(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_1:
		bit		1,	A			## bit 1
		jrz		__MUL16_bit_0
		SHIFT_1(B, C)
		ADD_DE_BC
		ld		A,	[tmp_lo]

	__MUL16_bit_0:
		bit		0,	A			## bit 0
		jrz		__MUL16_mov_return
		ld		H,	D
		ld		L,	E
		add		HL,	BC
		jr		__MUL16_return

	__MUL16_mov_return:
	ld		H,	D
	ld		L,	E
	__MUL16_return:
	pop		DE
	pop		BC
	ret
#}

%undef int8_mul_2
%undef int8_mul_4
%undef int8_mul_8
%undef int8_mul_16
%undef int8_mul_32
%undef int8_mul_64
%undef int8_mul_128
